<html>
<head>
    <meta charset="utf-8">
    <title>.sbvを作成（YouTube用）</title>
    <link rel='stylesheet' href='main.css?ver=1.0.0' type='text/css' media='all' />
    <script src="function.js"></script>
</head>

<body>
    <div id="banner"><span id="banner_text">.sbvを作成（YouTube用）</span></div>
    <form name="openForm">
            <div id="form_caption" >1.動画の開始から最初の字幕までのオフセットを設定（ミリ秒）</div>
            <input id="offset_milliseconds" type="text" name="offsetTime" value="0" style="text-align: right;">
            <div id="form_caption" >2.UDトークの会話ログ（.csv）を選択</div>
            <input id="file_select" name="csvFile" type="file" />
            <div id="form_caption" >3.変換結果を表示</div>
            <textarea id="convert_result" name="output" cols="200" rows="40"></textarea><br />
    </form>

    <hr />
    <p id="footer">CC BY Shamrock Records, Inc.</p>
    <script>
        var form = document.forms.openForm ;
        
        form.csvFile.addEventListener('click', function(e) {
            this.value = "" ;
        }) ;

        form.csvFile.addEventListener('change', function(e) {
            form.csvFile.textContent = "" ;

            var result = e.target.files[0];
            var reader = new FileReader() ;
        
            reader.readAsText(result) ;
        
            reader.addEventListener('load', function() {
                var content = reader.result ;
                var lines = convert(content) ;

                var result = "" ;
                var firstElement = true ;
                var offsetTime = "" ;
    
                for (var i=0; i<lines.length; i++) {
                    var elements = lines[i] ;
                    var nextElements = null ;
                    
                    if (i+1 < lines.length) {
                        nextElements = lines[i+1] ;
                    }

                    if (firstElement == true) {
                        offsetTime = ParseToDate(elements[0]) ;
                        firstElement = false ;
                    }

                    var beginTime = ParseToDate(elements[0]) ;
                    var endTime = nextElements != null ? ParseToDate(nextElements[0]) : new Date(beginTime.getTime() + 5000) ;
                    var content = elements[1] ;

                    beginTime -= offsetTime ;
                    endTime -= offsetTime ;
                    
                    beginTime = millisecToTime(Number(beginTime.toString()) + Number(form.offsetTime.value), ".") ;
                    endTime = millisecToTime(Number(endTime.toString()) + Number(form.offsetTime.value), ".") ;

                    if (beginTime != "" && endTime != "") {
                        result += beginTime + ',' + endTime + '\n' ;
                        result += content + '\n\n' ;
                    }
                }

                form.output.textContent = result ;
            })
        })
    </script>
</body>
</html>