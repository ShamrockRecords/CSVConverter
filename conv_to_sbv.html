<html>
<head>
    <meta charset="utf-8">
    <title>.sbvを作成（YouTube用）</title>
    <link rel='stylesheet' href='main.css?ver=1.0.0' type='text/css' media='all' />
    <script src="function.js"></script>
</head>

<body>
    <div id="banner"><span id="banner_text">.sbvを作成（YouTube用）</span></div>
    <div><p>【仕様】<ul><li>空白があり次の発話の開始時間が先の時は1文字あたりの発話にかかる時間を平均的な直で計算します。</li>
        <li>一番最後の発話は終わりの時間がわからないので分割処理をしません。</li>
        <li>ひとつの文字数を超えるか「。」で自動的に区切ります。</li>
        </ul>
            <p>※これらを正確に処理するためにはUDトークからの書き出しデータを変更する必要があるので少々お待ちください。</p>
        </p></div>
    <form name="openForm">
            <div id="form_caption" >1.動画の開始から最初の字幕までのオフセットを設定（ミリ秒）</div>
            <input id="offset_milliseconds" type="text" name="offsetTime" value="0" style="text-align: right;">
            <div id="form_caption" >2.ひとつの文字数（半分で折り返します）</div>
            <input id="line_count" type="text" name="lineCount" value="30" style="text-align: right;">
            <div id="form_caption" >3.オプション</div>
            <input id="replacing_dots" type="checkbox" name="replacingDots" value="" style="text-align: right;" checked>「、」は半角スペースに、「。」は削除する</input><br />
            <input id="dividing" type="checkbox" name="dividing" value="" style="text-align: right;" checked>行を半分で折り返す</input>
            <div id="form_caption" >4.UDトークの会話ログ（.csv）を選択</div>
            <input id="file_select" name="csvFile" type="file" />
            <div id="form_caption" >5.変換結果を表示</div>
            <textarea id="convert_result" name="output" cols="200" rows="40"></textarea><br />
    </form>

    <hr />
    <p id="footer">CC BY Shamrock Records, Inc.</p>
    <script type="text/javascript" src="tiny_segmenter.js" charset="UTF-8"></script>
    <script>
        var form = document.forms.openForm ;
        
        form.csvFile.addEventListener('click', function(e) {
            this.value = "" ;
        }) ;

        form.csvFile.addEventListener('change', function(e) {
            form.csvFile.textContent = "" ;

            var result = e.target.files[0];
            var reader = new FileReader() ;
        
            reader.readAsText(result) ;
        
            reader.addEventListener('load', function() {
                var content = reader.result ;
                var lines = convert(content) ;

                var replacingDots = form.replacingDots.checked ;
                var dividing = form.dividing.checked ;

                var result = "" ;
                var firstElement = true ;
                var offsetTime = "" ;

                for (var i=0; i<lines.length; i++) {
                    var elements = lines[i] ;
                    var nextElements = null ;
                    
                    if (i+1 < lines.length) {
                        nextElements = lines[i+1] ;
                    }

                    if (firstElement == true) {
                        offsetTime = ParseToDate(elements[0]) ;
                        firstElement = false ;
                    }

                    var beginTime = ParseToDate(elements[0]) ;
                    var endTime = nextElements != null ? ParseToDate(nextElements[0]) : 0 ;
                    var content = elements[1] ;

                    if (content.length == 0) {
                        continue ;
                    }

                    var timeOfChar = 60000 / 300 ; // average

                    if (endTime != 0) {
                        timeOfChar = (endTime - beginTime) / content.length ;
                    
                        if (timeOfChar > 60000 / 300) { // if over average, reset to average.
                            timeOfChar = 60000 / 300 ;   
                        }
                    }
                    
                    var countPerLine = Number(form.lineCount.value) ;
                    var currnetIndex = 0 ;
                    var currentOffset = 0 ;
                    var segmenter = new TinySegmenter();
                    var segs ;
                    
                    if (endTime != 0) {
                        segs = segmenter.segment(content); 
                    } else {
                        segs = new Array();
                        segs.push(content);
                    }

                    var tempContent = "";

                    for (var s=0; s<=segs.length; s++) {
                        
                        if (s < segs.length) {
                            var remainContent = "" ;

                            for (var t=s; t<segs.length; t++) {
                                remainContent += segs[t] ;
                            }

                            if (remainContent.length < 6) {
                                tempContent += remainContent ;
                                s = segs.length ;
                            } else {
                                tempContent += segs[s] ;
                            }    
                        }

                        if (tempContent.endsWith("。") || tempContent.length > countPerLine || s == segs.length) {
                            if (dividing) {
                                if (tempContent.length > countPerLine / 2) {
                                tempContent = tempContent.slice(0, countPerLine / 2) + "\n" + tempContent.slice(countPerLine / 2) ;
                                }
                            }
                                                       
                            tempContent = tempContent.trim();

                            if (replacingDots) {
                                tempContent = tempContent.replace("、", " ") ;
                                tempContent = tempContent.replace("、", " ") ;
                                tempContent = tempContent.replace("。", "") ;
                            }

                            if (tempContent.length != 0 && tempContent != "、" && tempContent != "。") {
                                var tempBeginTime = currnetIndex * timeOfChar ;   
                                var tempEndTime = tempBeginTime + (timeOfChar * tempContent.length) ;

                                tempBeginTime = Math.floor(tempBeginTime) ;
                                tempEndTime = Math.floor(tempEndTime) ;

                                var tempBeginTimeF = millisecToTime(Number((beginTime - offsetTime).toString()) + Number(form.offsetTime.value) + tempBeginTime, ".") ;
                                var tempEndTimeF = millisecToTime(Number((beginTime - offsetTime).toString()) + Number(form.offsetTime.value) + tempEndTime - 100, ".") ;

                                if (tempBeginTimeF != "" && tempEndTimeF != "") {
                                    result += tempBeginTimeF + ',' + tempEndTimeF + '\n' ;
                                    result += tempContent + '\n\n' ;
                                }
                            }
 
                            currnetIndex += tempContent.length ;
                            tempContent = "";
                        }
                    }
                }

                form.output.textContent = result ;
            })
        })
    </script>
</body>
</html>
